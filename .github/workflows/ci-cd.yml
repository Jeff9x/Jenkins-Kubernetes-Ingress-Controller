name: Automated Deployment to VM

# Trigger this pipeline on every push to the main branch
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    # Tell GitHub to run this job on your VM
    runs-on: self-hosted

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 3. Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          # Assumes Dockerfile is in the root of the repo
          context: .
          push: true
          # Tags the image with the unique Git commit SHA
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/my-app:${{ github.sha }}

      - name: 4. Deploy to Kubernetes
        run: |
          echo "Preparing deployment..."
          # Set up kubectl credentials from the secret
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ./kubeconfig
          export KUBECONFIG=./kubeconfig

          echo "Applying service configuration..."
          # It's good practice to apply the service file to ensure it's up to date.
          kubectl apply -f service.yaml

          echo "Updating deployment with the new image..."
          # This is the key command. It directly tells Kubernetes to update the image,
          # which triggers a rolling update and causes the cluster to pull the new image.
          # It's much safer than using 'sed'.

          # IMPORTANT: Replace 'my-app-deployment' with the name of your deployment
          # from the metadata.name field in your deployment.yaml file.
          # IMPORTANT: Replace 'my-app-container' with the name of the container
          # from the spec.template.spec.containers[0].name field in your deployment.yaml.
          kubectl set image deployment/my-app-deployment my-app-container=${{ secrets.DOCKERHUB_USERNAME }}/my-app:${{ github.sha }}

          echo "Deployment complete!"
